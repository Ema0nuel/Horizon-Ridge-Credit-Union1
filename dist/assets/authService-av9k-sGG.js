import{s as t}from"./index-DvGZ9O-H.js";import{s as m}from"./api-CBahbCmN.js";const U=15e3;function c(r,e=U){return Promise.race([r,new Promise((o,n)=>setTimeout(()=>n(new Error(`Request timed out after ${e}ms`)),e))])}const w={async signInWithAccountNumber(r,e){try{console.log("[AUTH_LOGIN] Step 1: Looking up account:",r);const{data:o,error:n}=await c(t.from("accounts").select("user_id").eq("account_number",r).eq("is_deleted",!1).single());if(n)throw console.error("[AUTH_LOGIN] Step 1 FAILED - Account not found:",n.message),new Error("Account not found. Please check your account number.");if(!o?.user_id)throw console.error("[AUTH_LOGIN] Step 1 FAILED - No user_id in account record"),new Error("Account data is incomplete.");const s=o.user_id;console.log("[AUTH_LOGIN] Step 1 SUCCESS - user_id:",s),console.log("[AUTH_LOGIN] Step 2: Looking up user profile for user_id:",s);const{data:i,error:d}=await c(t.from("user_profiles").select("email").eq("id",s).eq("is_deleted",!1).maybeSingle());if(d)throw console.error("[AUTH_LOGIN] Step 2 FAILED - Profile lookup error:",d.message),new Error("User profile not found.");if(!i?.email)throw console.error("[AUTH_LOGIN] Step 2 FAILED - No email in profile"),new Error("User profile is incomplete.");console.log("[AUTH_LOGIN] Step 2 SUCCESS - email:",i.email),console.log("[AUTH_LOGIN] Step 3: Signing in with Supabase Auth");const{data:a,error:l}=await c(t.auth.signInWithPassword({email:i.email,password:e}));if(l)throw console.error("[AUTH_LOGIN] Step 3 FAILED - Auth error:",l.message),new Error("Invalid password or account is locked.");if(!a.user)throw console.error("[AUTH_LOGIN] Step 3 FAILED - No user in auth response"),new Error("Sign in failed unexpectedly.");return console.log("[AUTH_LOGIN] Step 3 SUCCESS - user_id:",a.user.id),console.log("[AUTH_LOGIN] ===== LOGIN COMPLETE ====="),{user:a.user,session:a.session}}catch(o){throw console.error("[AUTH_LOGIN] ===== LOGIN FAILED ====="),console.error("[AUTH_LOGIN] Error:",o.message),o}},async signUp(r,e,o,n,s,i,d){try{console.log("[AUTH_SIGNUP] Step 1: Creating Supabase Auth user");const{data:a,error:l}=await c(t.auth.signUp({email:r,password:e,options:{data:{full_name:o,phone_number:n,date_of_birth:s}}}));if(l)throw console.error("[AUTH_SIGNUP] Step 1 FAILED:",l.message),new Error(l.message||"Failed to create auth user");const u=a.user?.id;if(!u)throw console.error("[AUTH_SIGNUP] Step 1 FAILED - No userId"),new Error("Failed to create user account");console.log("[AUTH_SIGNUP] Step 1 SUCCESS - userId:",u),console.log("[AUTH_SIGNUP] Step 2: Creating user profile");const{error:p}=await c(t.from("user_profiles").insert({id:u,email:r,full_name:o,phone_number:n,date_of_birth:s,kyc_status:"pending",is_active:!0,metadata:{},feature_flags:{}}));if(p)throw console.error("[AUTH_SIGNUP] Step 2 FAILED:",p.message),new Error(`Failed to create profile: ${p.message}`);console.log("[AUTH_SIGNUP] Step 2 SUCCESS"),console.log("[AUTH_SIGNUP] Step 3: Creating account");const g=Math.floor(Math.random()*9e9+1e9).toString(),{error:S}=await c(t.from("accounts").insert({user_id:u,account_number:g,account_type:i,currency:d,status:"active",balance:0,available_balance:0,daily_transaction_limit:1e8,monthly_transaction_limit:1e8,metadata:{},feature_flags:{},settings:{}}));if(S)throw console.error("[AUTH_SIGNUP] Step 3 FAILED:",S.message),new Error(`Failed to create account: ${S.message}`);return console.log("[AUTH_SIGNUP] Step 3 SUCCESS - account:",g),console.log("[AUTH_SIGNUP] Step 4: Sending welcome email"),_(r,o,g,e).catch(f=>{console.warn("[AUTH_SIGNUP] Email send failed (non-critical):",f.message)}),console.log("[AUTH_SIGNUP] ===== SIGNUP COMPLETE ====="),{success:!0,accountNumber:g,userId:u}}catch(a){throw console.error("[AUTH_SIGNUP] ===== SIGNUP FAILED ====="),console.error("[AUTH_SIGNUP] Error:",a.message),a}},async resetPasswordRequest(r){try{console.log("[AUTH_RESET] Requesting password reset for:",r);const{error:e}=await c(t.auth.resetPasswordForEmail(r,{redirectTo:`${window.location.origin}/auth/reset-password`}));if(e)throw e;return console.log("[AUTH_RESET] SUCCESS"),{success:!0}}catch(e){throw console.error("[AUTH_RESET] FAILED:",e.message),new Error(e.message||"Password reset request failed")}},async updatePassword(r){try{console.log("[AUTH_UPDATE_PWD] Updating password");const{error:e}=await c(t.auth.updateUser({password:r}));if(e)throw e;return console.log("[AUTH_UPDATE_PWD] SUCCESS"),{success:!0}}catch(e){throw console.error("[AUTH_UPDATE_PWD] FAILED:",e.message),new Error(e.message||"Password update failed")}},async signOut(){try{console.log("[AUTH_SIGNOUT] Signing out");const{error:r}=await c(t.auth.signOut());if(r)throw r;return console.log("[AUTH_SIGNOUT] SUCCESS"),{success:!0}}catch(r){throw console.error("[AUTH_SIGNOUT] FAILED:",r.message),new Error(r.message||"Sign out failed")}},async getSession(){try{const{data:{session:r},error:e}=await t.auth.getSession();if(e)throw e;return r}catch(r){return console.warn("[AUTH_SESSION] Get session error:",r.message),null}},async getUserProfile(r){try{const{data:e,error:o}=await t.from("user_profiles").select("*").eq("id",r).eq("is_deleted",!1).maybeSingle();return o?(console.warn("[AUTH_PROFILE] Get profile error:",o.message),null):e}catch(e){return console.warn("[AUTH_PROFILE] Get profile exception:",e.message),null}},async getUserAccounts(r){try{const{data:e,error:o}=await t.from("accounts").select("*").eq("user_id",r).eq("is_deleted",!1).order("created_at",{ascending:!1});return o?(console.warn("[AUTH_ACCOUNTS] Get accounts error:",o.message),[]):e||[]}catch(e){return console.warn("[AUTH_ACCOUNTS] Get accounts exception:",e.message),[]}}};async function _(r,e,o,n){try{const s="Welcome to Horizon Ridge Credit Union â€“ Your Account Details",i=A(e,o,n);await m({to:r,subject:s,html:i}),console.log("[EMAIL_SERVICE] Welcome email sent to:",r)}catch(s){throw console.error("[EMAIL_SERVICE] Failed to send email:",s.message),s}}function A(r,e,o){return`
    <!DOCTYPE html>
    <html>
      <head><meta charset="UTF-8" /></head>
      <body style="font-family: Montserrat, sans-serif; color: #1b1b1b; line-height: 1.6;">
        <div style="max-width: 600px; margin: 0 auto; background: #fff; border: 1px solid #1b1b1b; border-radius: 3px;">
          <div style="background: #1b1b1b; color: #fff; padding: 30px; text-align: center;">
            <h1 style="margin: 0; font-size: 28px;">Welcome to Horizon Ridge Credit Union</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Your Banking Partner</p>
          </div>
          <div style="padding: 30px;">
            <p>Hello ${r},</p>
            <p>Your account has been successfully created. Here are your credentials:</p>
            <div style="background: #f9f9f9; border-left: 4px solid #f10; padding: 20px; margin: 20px 0;">
              <p><strong>Account Number:</strong> <code style="font-family: monospace; background: #fff; padding: 2px 6px;">${e}</code></p>
              <p><strong>Temporary Password:</strong> <code style="font-family: monospace; background: #fff; padding: 2px 6px;">${o}</code></p>
              <p style="font-size: 12px; color: #666;">âš  Please change your password immediately after login.</p>
            </div>
          </div>
        </div>
      </body>
    </html>
  `}const I=async r=>{try{const{error:e}=await t.auth.signOut();e&&console.error("[DASHBOARD] signOut error:",e),r("/auth/login",{replace:!0})}catch(e){console.error("SignOut err exception:",e)}};export{w as a,I as h};
