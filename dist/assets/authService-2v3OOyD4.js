import{s as t}from"./index-BaOxJvox.js";import{s as h}from"./api-CBahbCmN.js";const w=15e3;function n(r,e=w){return Promise.race([r,new Promise((o,s)=>setTimeout(()=>s(new Error(`Request timed out after ${e}ms`)),e))])}const I={async signInWithAccountNumber(r,e){try{const{data:o,error:s}=await n(t.from("accounts").select("user_id").eq("account_number",r).eq("is_deleted",!1).single());if(s)throw console.error("[AUTH_LOGIN] Step 1 FAILED - Account not found:",s.message),new Error("Account not found. Please check your account number.");if(!o?.user_id)throw console.error("[AUTH_LOGIN] Step 1 FAILED - No user_id in account record"),new Error("Account data is incomplete.");const a=o.user_id,{data:i,error:l}=await n(t.from("user_profiles").select("email").eq("id",a).eq("is_deleted",!1).maybeSingle());if(l)throw console.error("[AUTH_LOGIN] Step 2 FAILED - Profile lookup error:",l.message),new Error("User profile not found.");if(!i?.email)throw console.error("[AUTH_LOGIN] Step 2 FAILED - No email in profile"),new Error("User profile is incomplete.");const{data:c,error:u}=await n(t.auth.signInWithPassword({email:i.email,password:e}));if(u)throw console.error("[AUTH_LOGIN] Step 3 FAILED - Auth error:",u.message),new Error("Invalid password or account is locked.");if(!c.user)throw console.error("[AUTH_LOGIN] Step 3 FAILED - No user in auth response"),new Error("Sign in failed unexpectedly.");return{user:c.user,session:c.session}}catch(o){throw console.error("[AUTH_LOGIN] ===== LOGIN FAILED ====="),console.error("[AUTH_LOGIN] Error:",o.message),o}},async signUp(r,e,o,s,a,i,l){try{const{data:c,error:u}=await n(t.auth.signUp({email:r,password:e,options:{data:{full_name:o,phone_number:s,date_of_birth:a}}}));if(u)throw console.error("[AUTH_SIGNUP] Step 1 FAILED:",u.message),new Error(u.message||"Failed to create auth user");const d=c.user?.id;if(!d)throw console.error("[AUTH_SIGNUP] Step 1 FAILED - No userId"),new Error("Failed to create user account");const{error:m}=await n(t.from("user_profiles").insert({id:d,email:r,full_name:o,phone_number:s,date_of_birth:a,kyc_status:"pending",is_active:!0,metadata:{},feature_flags:{}}));if(m)throw console.error("[AUTH_SIGNUP] Step 2 FAILED:",m.message),new Error(`Failed to create profile: ${m.message}`);const f=Math.floor(Math.random()*9e9+1e9).toString(),{error:p}=await n(t.from("accounts").insert({user_id:d,account_number:f,account_type:i,currency:l,status:"active",balance:0,available_balance:0,daily_transaction_limit:1e8,monthly_transaction_limit:1e8,metadata:{},feature_flags:{},settings:{}}));if(p)throw console.error("[AUTH_SIGNUP] Step 3 FAILED:",p.message),new Error(`Failed to create account: ${p.message}`);return _(r,o,f,e).catch(g=>{console.warn("[AUTH_SIGNUP] Email send failed (non-critical):",g.message)}),{success:!0,accountNumber:f,userId:d}}catch(c){throw console.error("[AUTH_SIGNUP] ===== SIGNUP FAILED ====="),console.error("[AUTH_SIGNUP] Error:",c.message),c}},async resetPasswordRequest(r){try{const{error:e}=await n(t.auth.resetPasswordForEmail(r,{redirectTo:`${window.location.origin}/auth/reset-password`}));if(e)throw e;return{success:!0}}catch(e){throw console.error("[AUTH_RESET] FAILED:",e.message),new Error(e.message||"Password reset request failed")}},async updatePassword(r){try{const{error:e}=await n(t.auth.updateUser({password:r}));if(e)throw e;return{success:!0}}catch(e){throw console.error("[AUTH_UPDATE_PWD] FAILED:",e.message),new Error(e.message||"Password update failed")}},async signOut(){try{const{error:r}=await n(t.auth.signOut());if(r)throw r;return{success:!0}}catch(r){throw console.error("[AUTH_SIGNOUT] FAILED:",r.message),new Error(r.message||"Sign out failed")}},async getSession(){try{const{data:{session:r},error:e}=await t.auth.getSession();if(e)throw e;return r}catch(r){return console.warn("[AUTH_SESSION] Get session error:",r.message),null}},async getUserProfile(r){try{const{data:e,error:o}=await t.from("user_profiles").select("*").eq("id",r).eq("is_deleted",!1).maybeSingle();return o?(console.warn("[AUTH_PROFILE] Get profile error:",o.message),null):e}catch(e){return console.warn("[AUTH_PROFILE] Get profile exception:",e.message),null}},async getUserAccounts(r){try{const{data:e,error:o}=await t.from("accounts").select("*").eq("user_id",r).eq("is_deleted",!1).order("created_at",{ascending:!1});return o?(console.warn("[AUTH_ACCOUNTS] Get accounts error:",o.message),[]):e||[]}catch(e){return console.warn("[AUTH_ACCOUNTS] Get accounts exception:",e.message),[]}}};async function _(r,e,o,s){try{const a="Welcome to Summit Ridge Credit Union â€“ Your Account Details",i=A(e,o,s);await h({to:r,subject:a,html:i})}catch(a){throw console.error("[EMAIL_SERVICE] Failed to send email:",a.message),a}}function A(r,e,o){return`
    <!DOCTYPE html>
    <html>
      <head><meta charset="UTF-8" /></head>
      <body style="font-family: Montserrat, sans-serif; color: #1b1b1b; line-height: 1.6;">
        <div style="max-width: 600px; margin: 0 auto; background: #fff; border: 1px solid #1b1b1b; border-radius: 3px;">
          <div style="background: #1b1b1b; color: #fff; padding: 30px; text-align: center;">
            <h1 style="margin: 0; font-size: 28px;">Welcome to Summit Ridge Credit Union</h1>
            <p style="margin: 10px 0 0 0; opacity: 0.9;">Your Banking Partner</p>
          </div>
          <div style="padding: 30px;">
            <p>Hello ${r},</p>
            <p>Your account has been successfully created. Here are your credentials:</p>
            <div style="background: #f9f9f9; border-left: 4px solid #f10; padding: 20px; margin: 20px 0;">
              <p><strong>Account Number:</strong> <code style="font-family: monospace; background: #fff; padding: 2px 6px;">${e}</code></p>
              <p><strong>Temporary Password:</strong> <code style="font-family: monospace; background: #fff; padding: 2px 6px;">${o}</code></p>
              <p style="font-size: 12px; color: #666;">âš  Please change your password immediately after login.</p>
            </div>
          </div>
        </div>
      </body>
    </html>
  `}const U=async r=>{try{const{error:e}=await t.auth.signOut();e&&console.error("[DASHBOARD] signOut error:",e),r("/auth/login",{replace:!0})}catch(e){console.error("SignOut err exception:",e)}};export{I as a,U as h};
